# Generated by Makr 1.0.4
# https://github.com/willowtreeapps/Makr

# Path for built products
ARTIFACTS_PATH = artifacts

# Path for built archives
ARCHIVES_PATH = $(ARTIFACTS_PATH)/archives

# Path for built IPAs
IPAS_PATH = $(ARTIFACTS_PATH)/ipas

# Provisioning profiles dir
PROFILES_DIR = $(CURDIR)/profiles

# Temporary build dir
TEMP_DIR = $(CURDIR)/tmp

# Build environment vars
CONFIGURATION_BUILD_DIR = $(TEMP_DIR)/configuration

BUILD_ENV_OPTIONS = SHARED_PRECOMPS_DIR="$(TEMP_DIR)/precomps" \
		TARGET_TEMP_DIR="$(TEMP_DIR)/target/" \

# Archives
ARCHIVES = <% config["archives"].each do |archive| %>$(ARCHIVES_PATH)/<%= archive["name"] %>.xcarchive <% end %>

# IPAs
IPAS = <% Array(config["archives"]).each do |archive| -%>
<% Array(archive["ipas"]).each do |ipa| -%>
$(IPAS_PATH)/<%= ipa["name"] %>.ipa <% end -%><% end -%>

# Get current version
CURRENT_VERSION=$(shell agvtool what-version -terse)

# If build number if defined and it's different than the current build number
# add update-version step to be used for all target
ifdef BUILD_NUMBER
UPDATE_VERSION = update-version
else
UPDATE_VERSION=
endif

# Updates project version if needed and generates all IPAs
all: $(UPDATE_VERSION) $(IPAS)

# Create profiles directory
$(PROFILES_DIR):
	mkdir $@

# Install provisioning profiles
install-profiles: $(PROFILES_DIR)
	rsync -av ./profiles/ ~/Library/MobileDevice/Provisioning\ Profiles/

# Updates project version using agvtool
update-version:
	agvtool new-version -all $(CURRENT_VERSION).$(BUILD_NUMBER)
	agvtool new-marketing-version $(CURRENT_VERSION)

<% Array(config["archives"]).each do |archive| -%>
# Create <%=archive["name"]%>.xcarchive
$(ARCHIVES_PATH)/<%=archive["name"]%>.xcarchive:
	xcodebuild archive $(BUILD_ENV_OPTIONS) \
		-scheme "<%=archive["scheme"]%>" \
		<% if archive["workspace"] -%>-workspace "<%= archive["workspace"] %>.xcworkspace" \
		<% end -%>
		<% if archive["project"] -%>-project "<%= archive["project"] %>.xcodeproj" \
		<% end -%>
		-configuration "<%=archive["configuration"]%>"  \
		-archivePath $@
	rm -rf $(TEMP_DIR)

<% Array(archive["ipas"]).each do |ipa| -%>
# Create <%=ipa["name"]%>.ipa
$(IPAS_PATH)/<%=ipa["name"]%>.ipa: $(IPAS_PATH) $(ARCHIVES_PATH)/<%=archive["name"]%>.xcarchive
	xcodebuild -exportArchive \
		-exportFormat IPA \
		-exportProvisioningProfile "<%=ipa["profile"]%>" \
		-archivePath "$(ARCHIVES_PATH)/<%=archive["name"]%>.xcarchive" \
		-exportPath "$@"

<% Array(ipa["distributions"]).each do |distribution| -%>
<% if distribution["type"] == "testflight" -%>
# Upload <%=ipa["name"]%>.ipa to <%=distribution["type"]%>
distribute-<%= ipa["name"] %>-<%= distribution["name"] %>:
	curl http://testflightapp.com/api/builds.json \
		-F file=@'$(IPAS_PATH)/<%= ipa["name"] %>.ipa' \
		-F api_token='<%= distribution["api-token"] %>' \
		-F notes='<%= distribution["notes"] %>' \
		-F team_token='<%= distribution["team-token"] %>' \
		-F notify=<%= distribution["notify"].to_s.capitalize %> \
		-F distribution_lists='<%= distribution["distribution-list"] %>'

<% end -%>
<% end -%>
<% end -%>
<% end -%>
# Path to built IPAs
$(IPAS_PATH):
	mkdir -p $(IPAS_PATH)

# Run all distribution tasks
distribute-all: <% Array(config["archives"]).each do |archive| -%>
<% Array(archive["ipas"]).each do |ipa| -%>
<% Array(ipa["distributions"]).each do |distribution| -%>
 distribute-<%= ipa["name"] %>-<%= distribution["name"] -%>
<% end -%>
<% end -%>
<% end -%>


<% Array(config["tests"]).each do |test| -%>
# Test <%= test["name"] %>
test-<%= test["name"] %>:
	xcodebuild test <% if test["workspace"] -%>-workspace "<%= test["workspace"] %>.xcworkspace"<% end %><% if test["project"] -%>-project "<%= test["project"] %>.xcodeproj"<% end %> -scheme "<%= test["scheme"] %>" -destination platform="<%= test["platform"] %>",OS="<%= test["os"] %>",name="<%= test["device"] %>"
<% end -%>

# Clean artifacts and temp directories
clean:
	rm -rf $(ARTIFACTS_PATH)
	rm -rf $(TEMP_DIR)
