# Generated by Makr 1.3.0
# https://github.com/willowtreeapps/Makr

# Path for built products
ARTIFACTS_PATH = artifacts

# Path for built archives
ARCHIVES_PATH = $(ARTIFACTS_PATH)/archives

# Path for built IPAs
IPAS_PATH = $(ARTIFACTS_PATH)/ipas

# Provisioning profiles dir
PROFILES_DIR = $(CURDIR)/profiles

# Temporary build dir
TEMP_DIR = $(CURDIR)/tmp

# Build environment vars
CONFIGURATION_BUILD_DIR = $(TEMP_DIR)/configuration

BUILD_ENV_OPTIONS = SHARED_PRECOMPS_DIR="$(TEMP_DIR)/precomps" \
		TARGET_TEMP_DIR="$(TEMP_DIR)/target/" \

# Archives
ARCHIVES = <% config["archives"].each do |archive| %>$(ARCHIVES_PATH)/<%= archive["name"] %>.xcarchive <% end %>

# IPAs
IPAS = <% Array(config["archives"]).each do |archive| -%>
<% Array(archive["ipas"]).each do |ipa| -%>
$(IPAS_PATH)/<%= ipa["name"] %>.ipa <% end -%><% end -%>

# Generates all IPAs
all: $(IPAS)

# Create profiles directory
$(PROFILES_DIR):
	mkdir $@

# Install provisioning profiles
install-profiles: $(PROFILES_DIR)
	rsync -av ./profiles/ ~/Library/MobileDevice/Provisioning\ Profiles/

<% Array(config["archives"]).each do |archive| -%>
# Create <%=archive["name"]%>.xcarchive
$(ARCHIVES_PATH)/<%=archive["name"]%>.xcarchive:
	xcodebuild archive $(BUILD_ENV_OPTIONS) \
		-scheme "<%=archive["scheme"]%>" \
		<% if archive["workspace"] -%>-workspace "<%= archive["workspace"] %>.xcworkspace" \
		<% end -%>
		<% if archive["project"] -%>-project "<%= archive["project"] %>.xcodeproj" \
		<% end -%>
		-configuration "<%=archive["configuration"]%>"  \
		-archivePath $@
	rm -rf $(TEMP_DIR)

<% Array(archive["ipas"]).each do |ipa| -%>
# Create <%=ipa["name"]%>.ipa
$(IPAS_PATH)/<%=ipa["name"]%>.ipa: $(IPAS_PATH) $(ARCHIVES_PATH)/<%=archive["name"]%>.xcarchive
	xcodebuild -exportArchive \
		-exportOptionsPlist "<%=ipa["options"]%>" \
		-exportFormat IPA \
		-exportProvisioningProfile "<%=ipa["profile"]%>" \
		-archivePath "$(ARCHIVES_PATH)/<%=archive["name"]%>.xcarchive" \
		-exportPath "$@"

<% Array(ipa["distributions"]).each do |distribution| -%>
<% if distribution["type"] == "hockeyapp" -%>
# Upload <%=ipa["name"]%>.ipa to <%=distribution["type"]%>
distribute-<%= ipa["name"] %>-<%= distribution["name"] %>:
	curl https://rink.hockeyapp.net/api/2/apps/upload \
	-H 'X-HockeyAppToken: <%= distribution["api-token"] %>' \
	-F ipa=@'$(IPAS_PATH)/<%= ipa["name"] %>.ipa' \
	-F notes='<%= distribution["notes"] %>' \
	-F notes_type='<%= distribution["notes_type"] %>' \
	-F notify='<%= distribution["notify"] %>' \
	-F status='<%= distribution["status"] %>' \
	-F tags='<%= distribution["tags"] %>' \
	-F teams='<%= distribution["teams"] %>' \
	-F users='<%= distribution["users"] %>' \
	-F mandatory='<%= distribution["mandatory"] %>' \
	-F release_type='<%= distribution["release_type"] %>' \
	-F private='<%= distribution["private"] %>' \
	-F commit_sha='<%= distribution["commit_sha"] %>' \
	-F build_server_url='<%= distribution["build_server_url"] %>' \
	-F repository_url='<%= distribution["repository_url"] %>' \

<% end -%>
<% end -%>
<% end -%>
<% end -%>
# Path to built IPAs
$(IPAS_PATH):
	mkdir -p $(IPAS_PATH)

# Run all distribution tasks
distribute-all: <% Array(config["archives"]).each do |archive| -%>
<% Array(archive["ipas"]).each do |ipa| -%>
<% Array(ipa["distributions"]).each do |distribution| -%>
 distribute-<%= ipa["name"] %>-<%= distribution["name"] -%>
<% end -%>
<% end -%>
<% end -%>


<% Array(config["tests"]).each do |test| -%>
# Test <%= test["name"] %>
test-<%= test["name"] %>:
	xcodebuild test <% if test["workspace"] -%>-workspace "<%= test["workspace"] %>.xcworkspace"<% end %><% if test["project"] -%>-project "<%= test["project"] %>.xcodeproj"<% end %> -scheme "<%= test["scheme"] %>" -destination platform="<%= test["platform"] %>",OS="<%= test["os"] %>",name="<%= test["device"] %>"
<% end -%>

# Clean artifacts and temp directories
clean:
	rm -rf $(ARTIFACTS_PATH)
	rm -rf $(TEMP_DIR)
